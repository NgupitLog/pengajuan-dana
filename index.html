<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Form Pengajuan Estimasi Dana</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}
h2 { color:#0b4ea2; }

.header, .so-block {
  background:#fff;
  padding:15px;
  border-radius:6px;
  margin-bottom:20px;
  border-left:5px solid #ff8c00;
}

label { font-size:13px; font-weight:bold; }
input, select {
  width:100%;
  padding:6px;
  margin-bottom:10px;
  font-size:13px;
}

.row { display:flex; gap:10px; }
.col { flex:1; }

table { width:100%; border-collapse:collapse; margin-top:10px; }
th {
  background:#0b4ea2;
  color:#fff;
  padding:6px;
}
td { padding:6px; }

.btn {
  background:#ff8c00;
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:4px;
  cursor:pointer;
}
.btn-blue { background:#0b4ea2; }
.btn-danger { background:#e74c3c; }

.total {
  margin-top:10px;
  font-weight:bold;
}

/* SEARCH COMPANY */
#companySearch {
  margin-bottom:6px;
}
#companyName {
  height:auto;
}
</style>
</head>

<body>

<h2>Form Pengajuan Estimasi Dana</h2>

<div class="header">
  <div class="row">
    <div class="col">
      <label>PIC</label>
      <select id="pic">
        <option value="">-- pilih --</option>
      </select>
    </div>

    <div class="col">
      <label>Belongs To</label>
      <select id="belongsTo">
        <option value="">-- pilih --</option>
        <option>Ngupit</option>
        <option>Paksi</option>
      </select>
    </div>

    <div class="col">
      <label>Company Name</label>
      <input type="text" id="companySearch" placeholder="Cari company..." autocomplete="off">
      <select id="companyName" size="5"></select>
    </div>
  </div>
</div>

<div id="soContainer"></div>

<button class="btn btn-blue" id="btnAddSO">+ Tambah SO</button>
<br><br>
<button class="btn" id="btnSubmit">SUBMIT</button>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwLS1VOGQkYqBTkyJTtwA22yldbHC1SCmyvmXPKsa1Yl8IOFUVfIoL6XQcOi9jFVRqNVQ/exec";

  const picSelect = document.getElementById("pic");
  const companySelect = document.getElementById("companyName");
  const companySearch = document.getElementById("companySearch");
  const soContainer = document.getElementById("soContainer");
  const btnAddSO = document.getElementById("btnAddSO");
  const btnSubmit = document.getElementById("btnSubmit");

  let companyList = [];

  /* ===== LOAD PIC ===== */
  fetch(SCRIPT_URL + "?type=pic")
    .then(r => r.json())
    .then(list => {
      if (!Array.isArray(list)) return;
      list.forEach(v => {
        picSelect.insertAdjacentHTML("beforeend", `<option>${v}</option>`);
      });
    });

  /* ===== LOAD COMPANY ===== */
  fetch(SCRIPT_URL + "?type=company")
    .then(r => r.json())
    .then(list => {
      if (!Array.isArray(list)) return;
      companyList = list;
      renderCompany(list);
    });

  function renderCompany(list) {
    companySelect.innerHTML = "";
    list.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      companySelect.appendChild(opt);
    });
  }

  companySearch.addEventListener("input", function () {
    const keyword = this.value.toLowerCase();
    const filtered = companyList.filter(c =>
      c.toLowerCase().includes(keyword)
    );
    renderCompany(filtered);
  });

  companySelect.addEventListener("change", function () {
    companySearch.value = this.value;
  });

  /* ===== ADD SO ===== */
  function addSO() {
    const so = document.createElement("div");
    so.className = "so-block";

    so.innerHTML = `
      <h3>Detail SO</h3>

      <div class="row">
        <div class="col"><label>SO Number</label><input class="soNumber"></div>
        <div class="col"><label>BL / AJU</label><input class="blAju"></div>
        <div class="col"><label>ETA</label><input class="ETA"></div>
        <div class="col">
          <label>FCL / LCL</label>
          <select class="shipmentType">
            <option>FCL</option>
            <option>LCL</option>
          </select>
        </div>
        <div class="col"><label>QTY</label><input class="qty"></div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:40%">Jenis Biaya</th>
            <th style="width:50%">Nominal (Rp)</th>
            <th style="width:10%">Aksi</th>
          </tr>
        </thead>
        <tbody class="items"></tbody>
      </table>

      <button type="button" class="btn addBiaya">+ Tambah Biaya</button>
      <div class="total">Total SO: Rp <span class="totalSo">0</span></div>
    `;

    soContainer.appendChild(so);

    so.querySelector(".addBiaya").addEventListener("click", () => addItem(so));
    addItem(so);
  }

  function addItem(so) {
    const tbody = so.querySelector(".items");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <select class="jenisBiaya">
          <option>DO</option>
          <option>Storage</option>
          <option>Handling</option>
          <option>Trucking</option>
          <option>LOLO</option>
          <option>Others</option>
        </select>
      </td>
      <td><input type="number" class="nominal" value="0"></td>
      <td><button class="btn btn-danger">X</button></td>
    `;
    tbody.appendChild(tr);

    tr.querySelector(".nominal").addEventListener("input", () => calc(so));
    tr.querySelector(".btn-danger").addEventListener("click", () => {
      tr.remove();
      calc(so);
    });
  }

  function calc(so) {
    let total = 0;
    so.querySelectorAll(".nominal").forEach(n => total += Number(n.value || 0));
    so.querySelector(".totalSo").innerText = total.toLocaleString("id-ID");
  }

  /* ===== SUBMIT ===== */
  btnSubmit.addEventListener("click", () => {
    alert("SUBMIT OK â€“ backend sudah siap");
  });

  btnAddSO.addEventListener("click", addSO);

  addSO(); // default 1 SO
});
</script>

</body>
</html>
