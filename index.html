<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Form Pengajuan Estimasi Dana</title>

<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6f8;
  padding:20px;
}
h2{color:#0b4ea2}

.header,.so-block{
  background:#fff;
  padding:15px;
  border-radius:6px;
  margin-bottom:20px;
  border-left:5px solid #ff8c00;
}

label{font-size:13px;font-weight:bold}
input,select{
  width:100%;
  padding:6px;
  margin-bottom:6px;
  font-size:13px;
}

.row{display:flex;gap:10px;flex-wrap:wrap}
.col{flex:1}
.col.so{flex:2}
.col.bl{flex:2}
.col.eta{flex:1.4}
.col.ship{flex:1}
.col.qty{flex:.8}

table{width:100%;border-collapse:collapse;margin-top:10px}
th{background:#0b4ea2;color:#fff;padding:6px}
td{padding:6px}

td.aksi{text-align:center;vertical-align:middle}

.btn{
  background:#ff8c00;
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:4px;
  cursor:pointer;
}
.btn-blue{background:#0b4ea2}
.btn-danger{
  background:#e74c3c;
  padding:4px 10px;
  line-height:1;
}

.total{margin-top:8px;font-weight:bold}

#companySearch{margin-bottom:4px}

@media(max-width:768px){
  .row{flex-direction:column}
  .btn{width:100%}
}
</style>
</head>

<body>

<h2>Form Pengajuan Estimasi Dana</h2>

<div class="header">
  <div class="row">
    <div class="col">
      <label>PIC</label>
      <select id="pic"><option value="">-- pilih --</option></select>
    </div>

    <div class="col">
      <label>Belongs To</label>
      <select id="belongsTo">
        <option value="">-- pilih --</option>
        <option>Ngupit</option>
        <option>Paksi</option>
      </select>
    </div>

    <div class="col">
      <label>Company Name</label>
      <input id="companySearch" placeholder="Cari company...">
      <select id="companyName" size="5"></select>
    </div>
  </div>
</div>

<div id="soContainer"></div>

<button class="btn btn-blue" id="btnAddSO">+ Tambah SO</button>
<br><br>
<button class="btn" id="btnSubmit">SUBMIT</button>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const SCRIPT_URL="https://script.google.com/macros/s/AKfycbz7iYopJE_fuA7VmDk0PpBd-ZelViruUBKHESXOOdLFCdqgg1wZsiTziTh88kRmnJnjuw/exec";
const MONTH_ID=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

const pic=document.getElementById("pic");
const belongsTo=document.getElementById("belongsTo");
const companySearch=document.getElementById("companySearch");
const companySelect=document.getElementById("companyName");
const soContainer=document.getElementById("soContainer");
const btnAddSO=document.getElementById("btnAddSO");
const btnSubmit=document.getElementById("btnSubmit");

let companyList=[];
let submitting=false;

/* LOAD PIC */
fetch(SCRIPT_URL+"?type=pic").then(r=>r.json()).then(d=>{
  d.forEach(v=>pic.insertAdjacentHTML("beforeend",`<option>${v}</option>`));
});

/* LOAD COMPANY */
fetch(SCRIPT_URL+"?type=company").then(r=>r.json()).then(d=>{
  companyList=d;renderCompany(d);
});

function renderCompany(list){
  companySelect.innerHTML="";
  list.forEach(v=>companySelect.insertAdjacentHTML("beforeend",`<option>${v}</option>`));
}

/* SEARCH + AUTO HIDE */
companySearch.oninput=()=>{
  companySelect.style.display="block";
  renderCompany(companyList.filter(c=>c.toLowerCase().includes(companySearch.value.toLowerCase())));
};
companySelect.onchange=()=>{
  companySearch.value=companySelect.value;
  companySelect.style.display="none";
};
companySearch.onfocus=()=>companySelect.style.display="block";

/* FORMAT ETA */
function formatTanggal(val){
  if(!val) return "";
  const d=new Date(val);
  return `${d.getDate()} ${MONTH_ID[d.getMonth()]} ${d.getFullYear()}`;
}

/* ADD SO */
function addSO(){
  const so=document.createElement("div");
  so.className="so-block";
  so.innerHTML=`
  <button class="btn btn-danger" style="float:right">HAPUS SO</button>
  <h3>Detail SO</h3>

  <div class="row">
    <div class="col so"><label>SO Number</label><input class="soNumber"></div>
    <div class="col bl"><label>BL / AJU</label><input class="blAju"></div>
    <div class="col eta">
      <label>ETA</label>
      <input type="date" class="etaRaw">
      <input class="etaText" readonly placeholder="DD Bulan YYYY">
    </div>
    <div class="col ship"><label>FCL/LCL</label><select><option>FCL</option><option>LCL</option></select></div>
    <div class="col qty"><label>QTY</label><input></div>
  </div>

  <table>
    <thead><tr><th>Jenis Biaya</th><th>Nominal</th><th>Aksi</th></tr></thead>
    <tbody class="items"></tbody>
  </table>

  <button class="btn addBiaya">+ Tambah Biaya</button>
  <div class="total">Total SO: Rp <span>0</span></div>
  `;
  soContainer.appendChild(so);

  so.querySelector(".btn-danger").onclick=()=>so.remove();
  so.querySelector(".addBiaya").onclick=()=>addItem(so);

  const raw=so.querySelector(".etaRaw");
  const text=so.querySelector(".etaText");
  raw.onchange=()=>text.value=formatTanggal(raw.value);

  addItem(so);
}

function addItem(so){
  const tr=document.createElement("tr");
  tr.innerHTML=`
  <td><select><option>DO</option><option>Storage</option><option>Handling</option><option>Trucking</option><option>LOLO</option><option>Others</option></select></td>
  <td><input type="number" value="0"></td>
  <td class="aksi"><button class="btn btn-danger">X</button></td>`;
  so.querySelector(".items").appendChild(tr);

  tr.querySelector("input").oninput=()=>calc(so);
  tr.querySelector("button").onclick=()=>{tr.remove();calc(so)};
}

function calc(so){
  let t=0;
  so.querySelectorAll("tbody input").forEach(i=>t+=Number(i.value||0));
  so.querySelector(".total span").innerText=t.toLocaleString("id-ID");
}

/* SUBMIT LOCK + SEND */
btnSubmit.onclick=()=>{
  if(submitting) return;
  submitting=true;
  btnSubmit.disabled=true;
  btnSubmit.innerText="Mengirim...";

  fetch(SCRIPT_URL,{
    method:"POST",
    mode:"no-cors",
    body:JSON.stringify({submit:true})
  })
  .then(()=>alert("BERHASIL (data terkirim)"))
  .catch(()=>alert("GAGAL"))
  .finally(()=>{
    submitting=false;
    btnSubmit.disabled=false;
    btnSubmit.innerText="SUBMIT";
  });
};

btnAddSO.onclick=addSO;
addSO();

});
</script>

</body>
</html>
